node:
  id: edge1
  cluster: edge-gateway

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901


overload_manager:
  refresh_interval: 0.5s
  resource_monitors:
  - name: envoy.resource_monitors.fixed_heap
    typed_config:
      '@type': type.googleapis.com/envoy.extensions.resource_monitors.fixed_heap.v3.FixedHeapConfig
      max_heap_size_bytes: 1073741824 # 1Gb
  actions:
  - name: envoy.overload_actions.shrink_heap
    triggers:
    - name: envoy.resource_monitors.fixed_heap
      threshold:
        value: 0.9
  - name: envoy.overload_actions.stop_accepting_requests
    triggers:
    - name: envoy.resource_monitors.fixed_heap
      threshold:
        value: 0.95
        
        
layered_runtime:
  layers:
  - name: static_layer_0
    static_layer: 
      overload:
        global_downstream_max_connections: 50000 # limit

 
static_resources:
  clusters:
  - name: ads_cluster
    type: STRICT_DNS
    connect_timeout: 5s
    load_assignment:
      cluster_name: ads_cluster
      endpoints:
      - lb_endpoints:
        - endpoint: 
            address:
              socket_address:
                address: local.minami.cc # TODO
                port_value: 18000
                ipv4_compat: true
    health_checks:
    - timeout: 2s
      interval: 3s
      initial_jitter: 2s
      unhealthy_threshold: 2
      healthy_threshold: 2
      grpc_health_check:
        service_name: grpc.health.v1.Health
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        common_http_protocol_options:
          idle_timeout: 1s
        explicit_http_config:
          http2_protocol_options:
            max_concurrent_streams: 100
            connection_keepalive:
              interval: 2s
              timeout: 2s
#    transport_socket:
#      name: envoy.transport_sockets.tls
#      typed_config:
#        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
#        common_tls_context:
#          tls_params:
#            tls_minimum_protocol_version: TLSv1_2
#            tls_maximum_protocol_version: TLSv1_3
#          validation_context:
#            trusted_ca:
#              filename: /fullchain.pem # TODO
#            match_typed_subject_alt_names:
#            - san_type: DNS
#              matcher:
#                exact: '*.minami.cc' # TODO
#            allow_expired_certificate: true
    upstream_connection_options:
      tcp_keepalive: {}
         
    
dynamic_resources:
  lds_config:
    ads: {}
    resource_api_version: V3
  cds_config:
    ads: {}
    resource_api_version: V3
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
      envoy_grpc:
        cluster_name: ads_cluster
      timeout: 5s
      